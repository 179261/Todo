# 待办事项管理器项目说明（1.0版本，与1.1相似）

## 1. 项目概述

这是一个基于 Python 开发的桌面待办事项管理器，采用 Tkinter 构建图形界面，SQLite 作为本地数据库。它提供了以下核心功能：

- **今日视图**：展示当天需要完成的所有事项，支持添加、编辑、删除、标记完成、快速批量生成重复事项、计时器启动以及多天项目的进度提交。
- **日历视图**：以月历形式展示所有有事件的日子，点击日期可查看该日事件列表，双击日期或事件可跳转到今日视图。
- **计时器管理**：为每个未完成的事件启动正向计时或倒计时，计时器在后台运行，支持暂停/继续、手动完成，完成时自动更新事件状态。
- **系统托盘**：支持最小化到托盘，后台运行。
- **定时提醒**：每分钟检查一次是否有事件到达开始时间，弹出提醒窗口并播放声音。

## 2. 技术栈

- **Python 3.x**：开发语言。
- **Tkinter**：标准 GUI 库，用于构建界面。
- **SQLite3**：轻量级嵌入式数据库，存储事件和进度。
- **Pygame**：用于播放提醒音效。
- **Pillow (PIL)**：处理托盘图标图像。
- **pystray**：创建系统托盘图标。

## 3. 文件结构

```
.
├── main.py              # 程序入口，主应用窗口、标签页管理、系统托盘、提醒功能
├── database.py          # 数据库操作类，封装所有 SQL 操作
├── daily_view.py        # “今日”标签页视图，显示当天事件，支持各项操作
├── calendar_view.py     # “日历”标签页视图，月历展示，点击日期查看事件
├── timer_view.py        # 计时器相关组件：计时器窗口、全局计时管理器、计时器列表视图
└── resources/
    └── icon.png         # 托盘图标
    └── icon.ico		 # 程序图标
    └── reminder.mp3	 # 提醒声音
```

## 4. 主要组件与类说明

### 4.1 `Database` 类 (`database.py`)

数据库操作的核心类，负责与 SQLite 交互。

- **初始化**：连接数据库，创建 `events` 和 `progress` 两张表（若不存在）。
- **事件操作**：`add_event`、`update_event`、`delete_event`、`get_event`、`get_all_events`、`get_events_by_date`。
- **进度操作**：`add_progress`、`update_progress`、`get_progress_for_event_and_date`、`get_latest_progress_before_date`、`get_progress_for_date`。
- 使用 `sqlite3.Row` 使查询结果支持列名访问，返回字典格式。
- 外键约束：`progress` 表的 `event_id` 引用 `events.id`，并设置 `ON DELETE CASCADE`。

### 4.2 `TodoApp` 类 (`main.py`)

主应用程序类，负责整体界面布局、标签页创建、系统托盘、提醒机制。

- **初始化**：设置窗口样式，初始化数据库和计时管理器单例，创建三个标签页（今日、日历、计时器）。
- **标签页**：
  - `DailyView`：今日视图。
  - `CalendarView`：日历视图。
  - `TimerView`：计时器列表视图。
- **系统托盘**：使用 `pystray` 创建托盘图标，支持“显示窗口”和“退出”。
- **定时提醒**：通过 `root.after` 每 30 秒调用一次 `check_reminders`，检查当前时间是否有事件开始。若有且未提醒过，则弹出提醒窗口（`show_reminder`），同时播放声音（`pygame.mixer`）。
- **回调方法**：`set_daily_date` 用于日历双击日期时切换到今日视图并跳转日期；`open_timer_for_event` 用于从计时器列表打开具体计时窗口。

### 4.3 `DailyView` 类 (`daily_view.py`)

今日视图，展示指定日期的事件列表，支持排序和各类操作。

- **界面元素**：顶部日期标签、添加/快速添加/刷新按钮；中间 Treeview 显示事件（标题、开始时间、结束时间、状态）；底部操作按钮（标记完成、计时、编辑、删除、提交进度）。
- **排序功能**：点击列标题可按标题（实为 ID）、开始时间、状态排序。排序逻辑在 `_sort_events` 中实现。
- **多天项目处理**：
  - 状态列显示：若当天有手动提交的进度则显示“已提交 (xx%)”，否则取最近一次进度自动延续（“自动延续 (xx%)”），无进度则“未提交”。
  - 点击“提交进度”弹出对话框，记录当日进度值。
- **快速添加**：批量生成重复事项（如“背单词 第n天”），可自定义名称、每天数量、持续天数、开始日期和时间。
- **添加/编辑对话框**：包含标题、描述、开始/结束日期、开始时间（可选）、结束时间。若开始时间未填写且为单日事项，自动填充当前时间。

### 4.4 `CalendarView` 类 (`calendar_view.py`)

日历视图，按月显示事件分布。

- **月历绘制**：使用 `calendar.monthcalendar` 生成网格，通过 `get_event_dates_in_month` 获取当月所有有事件的日子，将对应日期的单元格背景色设为浅蓝色。
- **日期点击**：单击日期时，下方列表显示该日事件；双击日期则回调主应用的 `set_daily_date` 跳转到今日视图并显示该日事件。
- **事件列表**：显示选中日期的事件，双击事件也可跳转到今日视图。

### 4.5 计时器模块 (`timer_view.py`)

包含三个类：`TimerTask`、`TimerManager`、`TimerWindow`、`TimerView`。

- **`TimerTask`**：单个计时任务的数据结构，包含事件 ID、模式（stopwatch/countdown）、当前秒数、运行状态、关联的窗口对象。
- **`TimerManager`**（单例）：全局管理所有计时任务。
  - 维护一个 `tasks` 字典，键为事件 ID。
  - 提供 `add_task`、`remove_task`、`get_task`。
  - 内部通过 `_update` 方法每秒更新所有正在运行的任务（正向+1，倒计时-1）。倒计时归零时自动调用 `_complete_task` 标记事件完成。
  - 支持注册回调（如 `TimerView` 刷新列表）。
  - `refresh_daily_callback` 用于通知今日视图刷新。
- **`TimerWindow`**：单个计时器窗口，对应一个事件的计时界面。
  - 可选择模式（计时/倒计时），倒计时需设置初始时间。
  - 显示当前时间，开始/暂停按钮，完成按钮。
  - 窗口关闭时仅断开与任务的关联，计时任务仍在后台运行。
- **`TimerView`**：计时器列表标签页，显示所有正在进行的计时任务。
  - Treeview 列出事件标题、当前时间、运行状态。
  - 双击行打开对应计时窗口；提供“暂停/继续”和“完成”按钮。

## 5. 数据模型

### 5.1 事件表 (`events`)

| 字段           | 类型    | 说明                               |
| -------------- | ------- | ---------------------------------- |
| id             | INTEGER | 主键，自增                         |
| title          | TEXT    | 标题（必填）                       |
| description    | TEXT    | 描述                               |
| start_date     | TEXT    | 开始日期（YYYY-MM-DD）             |
| end_date       | TEXT    | 结束日期（NULL 表示单日事件）      |
| start_time     | TEXT    | 开始时间（HH:MM，可为空）          |
| end_time       | TEXT    | 结束时间（可为空）                 |
| completed      | INTEGER | 0未完成，1已完成（对单日事件有效） |
| is_recurring   | INTEGER | 是否为重复事件（预留）             |
| recurring_rule | TEXT    | 重复规则（预留）                   |

### 5.2 进度表 (`progress`)

| 字段                   | 类型                               | 说明                 |
| ---------------------- | ---------------------------------- | -------------------- |
| id                     | INTEGER                            | 主键，自增           |
| event_id               | INTEGER                            | 外键，关联 events.id |
| date                   | TEXT                               | 日期（YYYY-MM-DD）   |
| value                  | REAL                               | 进度值               |
| completed              | INTEGER                            | 该日是否完成         |
| UNIQUE(event_id, date) | 确保同一天同一事件只有一条进度记录 |                      |

## 6. 核心功能流程

### 6.1 事件添加与编辑

1. 在每日视图点击“添加事项”或双击事项或点击编辑，弹出对话框。
2. 填写标题（必填）、描述、日期、时间等，其中“结束日期”留空表示单日事件。
3. 开始时间通过复选框控制是否启用，若启用但用户未输入，则单日事件自动填充当前时间，多天项目留空。
4. 保存时调用 `db.add_event` 或 `db.update_event`。

 ### 6.2 多天项目进度管理

1. 多天项目在每日视图中显示为“未提交/已提交(x%)”状态。
2. 点击“提交进度”按钮，输入当日进度值（0-100），系统在 progress 表中插入或更新记录。
3. 若当日未手动提交，则显示最近一次进度的“自动延续”状态（通过 `get_latest_progress_before_date` 获取）。

### 6.3 计时器使用
1. 在今日视图选中一个未完成事件，点击“计时”打开计时窗口。
2. 选择模式（计时/倒计时），若倒计时则设置时间，点击“开始”。
3. 计时任务加入 `TimerManager`，每秒更新。
4. 可在计时器列表标签页查看所有运行中任务，并控制暂停/完成。
5. 手动点击“完成”或倒计时归零时，自动将事件标记为完成，并更新结束时间为当前时间（若原结束时间为空）。

### 6.4 提醒机制
1. 主应用启动后，每 30 秒调用 `check_reminders`。
2. 获取当天所有未完成且设置了开始时间的事件。
3. 若当前时间（精确到分钟）等于事件的开始时间，且该事件 ID 不在 `notified_events_today` 集合中，则触发提醒。
4. 提醒窗口弹出，同时播放声音，点击“知道了”停止声音并关闭窗口。

### 6.5 日历视图的事件标记
1. 切换月份时调用 `get_event_dates_in_month`，遍历所有事件，计算每个事件覆盖的日期（包括多天项目），收集所有日期字符串。
2. 绘制日历时，若日期在集合中，则将单元格背景色设为浅蓝色。
3. 单击日期调用 `on_date_click`，从数据库获取该日事件并显示在今日视图列表。

## 7. 关键设计要点

- **单例模式**：`TimerManager` 确保整个应用只有一个计时管理器，所有计时任务统一更新。
- **回调机制**：`TimerManager` 持有 `refresh_daily_callback`，在任务完成时刷新今日视图；`TimerView` 注册自身刷新回调，使列表随计时更新。
- **多天项目进度显示**：通过 `get_progress_for_event_and_date` 获取当天手动提交的进度；若无则查找最近一次进度（`get_latest_progress_before_date`）作为自动延续值。
- **排序**：今日视图的排序逻辑支持按状态（已完成/未完成）排序，其中多天项目的当日完成状态由进度记录决定。
- **托盘图标**：使用 `pystray` 创建托盘，隐藏主窗口后仍可运行，左击托盘图标可恢复窗口。
- **音频播放**：采用 `pygame.mixer` 异步播放提醒音，避免阻塞 GUI。

## 8. 使用说明

1. 确保安装所需依赖：
   ```bash
   pip install pygame pillow pystray
   ```
2. 准备提醒声音，放置于 `resources/reminder.mp3`（或`resources/reminder.wav`）。
3. 运行 `main.py` 启动程序。
4. 首次使用数据库会自动创建，无初始数据。
5. 右键托盘可以选择退出。

## 9. 注意事项

- 提醒功能依赖于系统时间精确到分钟，且需确保 `reminder/reminder.mp3` 或`resources/reminder.wav`文件存在（若无，则指向 `C:\Windows\Media\Alarm01.wav`）。
- 若要关闭程序，需右键托盘退出。主窗口关闭时隐藏到托盘，不退出。
- 输入开始时间需满足`hh:mm`格式，冒号要为英文半角`;`而非中文全角`；`，凌晨也要输入`00:mm`而非`0:mm`，才能正确开启提醒机制
- 计时器更新使用 `tk._default_root`，在多窗口环境下可能存在问题，但当前设计足够稳定。
- 数据库文件 `todo.db` 默认生成在程序运行目录。
- 可能存在一些历史遗留的无用和繁琐的代码。

---


